<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perfil - 4linhas</title>

    <!-- CSS base (reset, variáveis, estilos globais) -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='css/base.css') }}"
    />
    <!-- Estilos do componente do cabeçalho -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='css/components/header.css') }}"
    />
    <!-- CSS perfil/abas -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='css/pages/perfil.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='css/pages/perfil-novo.css') }}"
    />
    <!-- CSS inline extraído -->
    <!-- (migrado para components/header.css) -->

    <script src="{{ url_for('static', path='js/cart.js') }}"></script>

    <!-- Fonte Google Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    
    <!-- Leaflet (OpenStreetMap) - Gratuito -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Geocoder (reverse geocoding gratuito) -->
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.3/dist/leaflet-geoman.umd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.3/dist/leaflet-geoman.css" />
  </head>
  <body>
    <!-- =============== HEADER (partial) =============== -->
    {% include 'partials/header.html' %}

    <!-- MAIN CONTENT: PERFIL DE USUÁRIO -->
    <main class="profile-page">
      <section class="profile-hero">
        <h1>Minha Conta</h1>
        <p>Visão geral da sua conta e pedidos.</p>
      </section>

      <div class="profile-container">
        <!-- Sidebar de Navegação -->
        <aside class="profile-sidebar">
          <div class="profile-user-box">
            <div class="profile-pic-placeholder">
              <span>{{ cliente.nome[0] if cliente and cliente.nome else 'U' }}</span> 
            </div>
            <h3 class="profile-user-name">
              {{ cliente.nome if cliente else 'Usuário' }}
            </h3>
            <p class="profile-user-email">
              {{ cliente.email if cliente else 'email@exemplo.com' }}
            </p>
          </div>
          <nav class="profile-nav" role="tablist" aria-label="Seções da conta">
            <ul>
              <li>
                <a
                  href="#carrinho"
                  class="profile-nav-link"
                  data-tab="cart"
                  role="tab"
                  aria-selected="false"
                  >Meu Carrinho</a
                >
              </li>
              <li>
                <a
                  href="#pedidos"
                  class="profile-nav-link"
                  data-tab="orders"
                  role="tab"
                  aria-selected="false"
                  >Meus Pedidos</a
                >
              </li>
              <li>
                <a
                  href="#dados"
                  class="profile-nav-link"
                  data-tab="account"
                  role="tab"
                  aria-selected="false"
                  >Meus Dados</a
                >
              </li>
              <li>
                <a
                  href="#enderecos"
                  class="profile-nav-link"
                  data-tab="addresses"
                  role="tab"
                  aria-selected="false"
                  >Endereços</a
                >
              </li>
              <li>
                <a
                  href="#favoritos"
                  class="profile-nav-link"
                  data-tab="favorites"
                  role="tab"
                  aria-selected="false"
                  >Favoritos</a
                >
              </li>
              <li>
                <a
                  href="{{ url_for('logout') }}"
                  class="profile-nav-link logout"
                  >Sair</a
                >
              </li>
            </ul>
          </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <div class="profile-content">
          <!-- Seção: Meu Carrinho / Checkout -->
          <section id="tab-cart" class="tab-content" role="tabpanel" hidden>
            <div class="content-header">
              <h2>Meu Carrinho</h2>
              <p>Revise seus itens e finalize a compra.</p>
            </div>
            <div class="content-body" id="profile-cart-content">
              {% if carrinho and carrinho|length > 0 %}
              <div class="cart-page-content">
                <div class="cart-items-list">
                  <table class="cart-table">
                    <thead>
                      <tr>
                        <th colspan="2">Produto</th>
                        <th>Preço</th>
                        <th>Quantidade</th>
                        <th>Total</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in carrinho %}
                      <tr data-product-id="{{ item.id }}" style="border-bottom: 1px solid #f0f0f0; vertical-align: middle;">
                        <td style="padding: 1rem 0.5rem;">
                          <img
                            src="{{ url_for('static', path='/upload/img/' + item.imagem) if item.imagem else url_for('static', path='assets/logo/4linhas-bg-red.svg') }}"
                            alt="{{ item.nome }}"
                            class="item-image-large"
                            style="width: 96px; height: 96px; object-fit: cover; border-radius: 8px;"
                          />
                        </td>
                        <td style="padding: 1rem 0.5rem; font-weight: 700; color: #203647;">{{ item.nome }}</td>
                        <td style="padding: 1rem 0.5rem; font-weight: 600; color: #0d1b2a;">R$ {{ "%.2f"|format(item.preco)|replace('.', ',') }}</td>
                        <td style="padding: 1rem 0.5rem;">
                          <div class="quantity-selector" style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="hidden" class="quantity-input" value="{{ item.quantidade }}">
                            <button type="button" class="quantity-btn minus-btn" data-change="-1" style="padding: 0.4rem 0.6rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; background: white;">
                              <img src="{{ url_for('static', path='assets/icons/simbolo-de-menos.png') }}" alt="-" style="width: 16px; height: 16px;">
                            </button>
                            <span class="quantity-text" style="min-width: 2rem; text-align: center; font-weight: 600;">{{ item.quantidade }}</span>
                            <button type="button" class="quantity-btn plus-btn" data-change="1" style="padding: 0.4rem 0.6rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; background: white;">
                              <img src="{{ url_for('static', path='assets/icons/botao-de-simbolo-de-mais.png') }}" alt="+" style="width: 16px; height: 16px;">
                            </button>
                          </div>
                        </td>
                        <td class="item-total" style="padding: 1rem 0.5rem; font-weight: 700; color: #0d1b2a;">
                          R$ {{ "%.2f"|format(item.preco * item.quantidade)|replace('.', ',') }}
                        </td>
                        <td style="padding: 1rem 0.5rem;">
                          <button type="button" class="btn-remove-item" style="background: #fee2e2; border: none; border-radius: 4px; padding: 0.5rem; cursor: pointer; color: #991b1b; font-weight: 700;">&times;</button>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <div class="cart-summary-box">
                  <h4>Resumo do Pedido</h4>
                  <div class="summary-row">
                    <span>Subtotal</span>
                    <span class="summary-subtotal">R$ {{ "%.2f"|format(total)|replace('.', ',') }}</span>
                  </div>
                  <div class="summary-row total">
                    <span>Total</span>
                    <span class="summary-total">R$ {{ "%.2f"|format(total)|replace('.', ',') }}</span>
                  </div>
                  <form
                    action="{{ url_for('checkout') }}"
                    method="post"
                    class="profile-checkout-form"
                    data-source="profile"
                    style="margin-top: 1rem"
                  >
                    <input type="hidden" name="from_profile" value="true">
                    <button type="submit" class="btn-primary checkout-full-btn">
                      Finalizar Compra
                    </button>
                  </form>
                </div>
              </div>
              {% else %}
              <div class="empty-state">
                <p>Seu carrinho está vazio.</p>
                <a href="{{ url_for('catalogo') }}" class="btn-primary"
                  >Ver produtos</a
                >
              </div>
              {% endif %}
            </div>
          </section>

          <!-- Seção: Meus Pedidos -->
          <section id="tab-orders" class="tab-content" role="tabpanel" hidden>
            <div class="content-header">
              <h2>Meus Pedidos</h2>
              <p>Acompanhe o histórico e o status dos seus pedidos.</p>
            </div>
            <div class="content-body">
              {% if pedidos and pedidos|length > 0 %}
              <div class="orders-list">
                {% for pedido in pedidos %}
                <div class="order-card">
                  <div class="order-card-header">
                    <h3>Pedido #{{ pedido.id_pedido }}</h3>
                    <span class="order-status">{{ pedido.status }}</span>
                  </div>
                  <div class="order-card-body">
                    <p><strong>Data:</strong> {{ pedido.data_pedido }}</p>
                    <p>
                      <strong>Total:</strong> R$ {{ "%.2f"|format(pedido.valor_total if pedido.valor_total is defined else 0)|replace('.', ',') }}
                    </p>
                  </div>
                  {% if pedido.itens %}
                  <details class="order-card-details">
                    <summary>Ver Itens ({{ pedido.itens|length }})</summary>
                    <ul class="order-items-list">
                      {% for item in pedido.itens %}
                      <li class="order-item">
                        {% if item.produto and item.produto.imagem_caminho %}
                        <img
                          src="{{ url_for('static', path='/upload/img/' + item.produto.imagem_caminho) }}"
                          alt="{{ item.produto.nome }}"
                          class="item-image"
                        />
                        {% else %}
                        <img
                          src="{{ url_for('static', path='assets/logo/4linhas-bg-red.svg') }}"
                          alt="Imagem não disponível"
                          class="item-image"
                        />
                        {% endif %}
                        <div class="item-details">
                          <span class="item-name"
                            >{{ item.produto.nome if item.produto else 'Produto
                            não encontrado' }}</span
                          >
                          <span class="item-qty-price"
                            >{{ item.quantidade }} x R$ {{ "%.2f"|format(item.preco_unitario if item.preco_unitario is defined else 0)|replace('.', ',') }}</span
                          >
                        </div>
                        <span class="item-total"
                          >R$ {{ "%.2f"|format(item.quantidade * (item.preco_unitario if item.preco_unitario is defined else 0))|replace('.', ',') }}</span
                        >
                      </li>
                      {% endfor %}
                    </ul>
                  </details>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="empty-state">
                <p>Nenhum pedido encontrado.</p>
                <a href="{{ url_for('catalogo') }}" class="btn-primary"
                  >Começar a comprar</a
                >
              </div>
              {% endif %}
            </div>
          </section>

          <!-- Seção: Meus Dados -->
          <section id="tab-account" class="tab-content" role="tabpanel" hidden>
            <div class="content-header">
              <h2>Meus Dados</h2>
              <p>Gerencie suas informações pessoais e de segurança.</p>
            </div>
            <div class="content-body">
              <div class="data-card">
                <h4>Informações Pessoais</h4>
                <p>
                  <strong>Nome:</strong> {{ cliente.nome if cliente else
                  'Usuário' }}
                </p>
                <p>
                  <strong>Email:</strong> {{ cliente.email if cliente else
                  'email@exemplo.com' }}
                </p>
                <p><strong>CPF:</strong> {{ cliente.cpf }}</p>
                <p><strong>Telefone:</strong> {{ cliente.telefone }}</p>
                <p><strong>Endereço:</strong> {{ cliente.endereco }}</p>
              </div>
              <div class="data-card">
                <h4>Alterar Senha</h4>
                <form
                  action="{{ url_for('atualizar_senha') }}"
                  method="post"
                  class="password-update-form"
                >
                  <div class="form-group">
                    <label for="nova_senha">Nova Senha</label>
                    <input
                      type="password"
                      id="nova_senha"
                      name="nova_senha"
                      placeholder="••••••••"
                      required
                    />
                  </div>
                  <button type="submit" class="btn-primary">
                    Atualizar Senha
                  </button>
                </form>
              </div>
            </div>
          </section>

          <!-- Seção: Endereços -->
          <section
            id="tab-addresses"
            class="tab-content"
            role="tabpanel"
            hidden
          >
            <div class="addr-header">
              <h2>Meus Endereços</h2>
              <p>Gerencie seus endereços de entrega e faturamento.</p>
            </div>

            <!-- CARD DE MÚLTIPLOS ENDEREÇOS -->
            <div class="endereco-card">
              <!-- Lista dinâmica -->
              <div id="enderecos-lista"></div>

              <!-- Botão para abrir modal -->
              <button class="btn-add-endereco" onclick="abrirModalEndereco()">
                + Novo endereço
              </button>
            </div>

            <!-- MODAL DE NOVO ENDEREÇO  -->
            <div id="modal-endereco" class="modal-endereco">
              <div class="modal-content-endereco">
                <!-- LADO ESQUERDO -->
                <div class="modal-left">
                  <h3>Adicionar Novo Endereço</h3>

                  <label for="modal-cep">CEP</label>
                  <input type="text" id="modal-cep" maxlength="8" placeholder="Digite seu CEP" />

                  <label for="modal-logradouro">Endereço</label>
                  <input type="text" id="modal-logradouro" readonly />

                  <label for="modal-bairro">Bairro</label>
                  <input type="text" id="modal-bairro" readonly />

                  <label for="modal-cidade">Cidade</label>
                  <input type="text" id="modal-cidade" readonly />

                  <label for="modal-uf">Estado</label>
                  <input type="text" id="modal-uf" readonly />

                  <label for="modal-numero">Número</label>
                  <input type="text" id="modal-numero" placeholder="Digite o número" />

                  <div class="modal-botoes">
                    <button class="btn-salvar" onclick="salvarEndereco()">
                      Salvar
                    </button>
                    <button
                      class="btn-cancelar"
                      onclick="fecharModalEndereco()"
                    >
                      Cancelar
                    </button>
                  </div>
                </div>

                <!-- LADO DIREITO (MAPA) -->
                <div class="modal-right">
                  <div id="map-container" style="width: 100%; height: 100%; border-radius: 0 22px 22px 0;"></div>
                </div>
              </div>
            </div>
          </section>          <!-- JS da funcionalidade com Maps -->
          <script src="/static/js/pages/address_modal_maps.js"></script>

        <!-- Seção: Favoritos -->
        <section id="tab-favorites" class="tab-content" role="tabpanel" hidden>
          <div class="content-header">
            <h2>Meus Favoritos</h2>
            <p>Veja os produtos que você salvou.</p>
          </div>
          <div class="content-body">
            <div class="empty-state">
              <p>Você ainda não tem produtos favoritos.</p>
              <a href="{{ url_for('catalogo') }}" class="btn-primary">Ver Produtos</a>
            </div>
            <!-- A lista de favoritos seria renderizada aqui -->
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Modal de Busca -->
  <div id="search-modal" class="search-modal">
    <div class="search-modal-content">
      <div class="search-modal-header">
        <h3>Buscar Produtos</h3>
        <button class="close-modal" aria-label="Fechar">&times;</button>
      </div>
      <form class="search-modal-form">
        <input type="text" placeholder="Digite o que você está procurando..." class="search-modal-input">
        <button type="submit">Buscar</button>
      </form>
    </div>
  </div>

  {% include 'partials/footer.html' %}

  <!-- Script para alternância de abas e carrinho dinâmico -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // --- LÓGICA DE ABAS (Preservada) ---
      const navLinks = document.querySelectorAll('.profile-nav-link[data-tab]');
      const tabContents = document.querySelectorAll('.tab-content');

      function activateTab(tabName) {
        if (!tabName) {
          navLinks.forEach(link => {
            link.classList.remove('active');
            link.setAttribute('aria-selected', 'false');
          });
          tabContents.forEach(content => {
            content.classList.remove('active');
            content.setAttribute('hidden', '');
          });
          // Do not modify the URL here. Preserve any incoming hash set by links
          // (e.g. /perfil#cart). Clearing the hash on load caused redirects to
          // specific sections to be removed. Keep the URL intact and simply return.
          return;
        }

        let tabFound = false;
        navLinks.forEach(link => {
          const isActive = link.getAttribute('data-tab') === tabName;
          link.classList.toggle('active', isActive);
          link.setAttribute('aria-selected', isActive);
          if (isActive) {
            tabFound = true;
            // Center the active tab on mobile view
            if (window.innerWidth <= 960) {
              link.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',
                inline: 'center'
              });
            }
          }
        });

        tabContents.forEach(content => {
          const isContentActive = content.id === `tab-${tabName}`;
          content.classList.toggle('active', isContentActive);
          if (isContentActive) {
            content.removeAttribute('hidden');
          } else {
            content.setAttribute('hidden', '');
          }
        });

        if (tabFound) {
          window.location.hash = tabName;
        } else {
          // If no matching tab was found, do not clear the URL hash.
          // This preserves any intentional anchor in the URL and avoids
          // unexpectedly removing navigation state.
        }
      }

      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const tabName = link.getAttribute('data-tab');
          activateTab(tabName);
        });
      });
      
      const initialTab = window.location.hash.substring(1);
      if (initialTab) {
        activateTab(initialTab);
      } else {
        activateTab('');
      }
      window.addEventListener('hashchange', () => {
          const tabNameFromHash = window.location.hash.substring(1);
          activateTab(tabNameFromHash);
      });

      // --- LÓGICA DO CARRINHO DINÂMICO ---
      const cartContentEl = document.getElementById('profile-cart-content');
      if (cartContentEl) {
        cartContentEl.addEventListener('click', async (event) => {
          const target = event.target;
          const productRow = target.closest('tr[data-product-id]');
          if (!productRow) return;

          const productId = productRow.dataset.productId;
          
          if (target.matches('.btn-remove-item')) {
            await updateCartAPI(`/carrinho/remover/${productId}`, 'POST');
          }

          if (target.matches('.quantity-btn')) {
            const change = parseInt(target.dataset.change, 10);
            const quantityInput = productRow.querySelector('.quantity-input');
            const currentQuantity = parseInt(quantityInput.value, 10);
            const newQuantity = currentQuantity + change;

            if (newQuantity > 0) {
              const formData = new FormData();
              formData.append('quantidade', newQuantity);
              await updateCartAPI(`/carrinho/atualizar/${productId}`, 'POST', formData);
            } else {
              await updateCartAPI(`/carrinho/remover/${productId}`, 'POST');
            }
          }
        });
      }

      async function updateCartAPI(url, method, body = null) {
        if(cartContentEl) cartContentEl.classList.add('loading');
        try {
          const response = await fetch(url, { method, body, credentials: 'same-origin' });

          if (!response.ok) {
            // Se a resposta não for OK (ex: 401, 500), tenta ler a mensagem de erro do backend
            let errorMessage = 'Erro desconhecido ao atualizar carrinho.';
            try {
              const errorData = await response.json();
              errorMessage = errorData.message || errorMessage;
            } catch (jsonError) {
              // Se não conseguir ler o JSON de erro, usa a mensagem padrão
              console.error('Não foi possível ler a mensagem de erro JSON:', jsonError);
            }
            throw new Error(errorMessage);
          }

          const result = await response.json();

          if (result.success) {
            renderProfileCart(result.cart);
            if (window.atualizarContadorCarrinho) {
              window.atualizarContadorCarrinho();
            }
          } else {
            throw new Error(result.message || 'Erro ao atualizar carrinho');
          }
        } catch (error) {
          console.error('Erro na operação do carrinho:', error);
        } finally {
            if(cartContentEl) cartContentEl.classList.remove('loading');
        }
      }

      function renderProfileCart(cartData) {
        if (!cartContentEl) return;

        if (!cartData || !cartData.itens || cartData.itens.length === 0) {
          cartContentEl.innerHTML = `
            <div class="empty-state">
              <p>Seu carrinho está vazio.</p>
              <a href="{{ url_for('catalogo') }}" class="btn-primary">Ver produtos</a>
            </div>`;
          return;
        }

        const itemsHtml = cartData.itens.map(item => `
          <tr data-product-id="${item.id}">
            <td><img src="/static/upload/img/${item.imagem || 'default.jpg'}" alt="${item.nome}" class="item-image-large"/></td>
            <td>${item.nome}</td>
            <td>R$ ${parseFloat(item.preco).toFixed(2).replace('.', ',')}</td>
            <td>
              <div class="quantity-selector">
                <input type="hidden" class="quantity-input" value="${item.quantidade}">
                <button type="button" class="quantity-btn minus-btn" data-change="-1">-</button>
                <span class="quantity-text">${item.quantidade}</span>
                <button type="button" class="quantity-btn plus-btn" data-change="1">+</button>
              </div>
            </td>
            <td class="item-total">R$ ${(item.preco * item.quantidade).toFixed(2).replace('.', ',')}</td>
            <td><button type="button" class="btn-remove-item">&times;</button></td>
          </tr>
        `).join('');

        const total = cartData.total;
        cartContentEl.innerHTML = `
          <div class="cart-page-content">
            <div class="cart-items-list">
              <table class="cart-table">
                <thead>
                  <tr>
                    <th colspan="2">Produto</th><th>Preço</th><th>Quantidade</th><th>Total</th><th></th>
                  </tr>
                </thead>
                <tbody>${itemsHtml}</tbody>
              </table>
            </div>
            <div class="cart-summary-box">
              <h4>Resumo do Pedido</h4>
              <div class="summary-row">
                <span>Subtotal</span>
                <span class="summary-subtotal">R$ ${total.toFixed(2).replace('.', ',')}</span>
              </div>
              <div class="summary-row total">
                <span>Total</span>
                <span class="summary-total">R$ ${total.toFixed(2).replace('.', ',')}</span>
              </div>
              <form action="{{ url_for('checkout') }}" method="post" class="profile-checkout-form" data-source="profile" style="margin-top: 1rem">
                <input type="hidden" name="from_profile" value="true">
                <button type="submit" class="btn-primary checkout-full-btn">Finalizar Compra</button>
              </form>
            </div>
          </div>`;
      }
    });
  </script>
</body>
</html>

          <!--TESTE DA SECTION ENDEREÇO-->
          <script>
            document.addEventListener("DOMContentLoaded", () => {
              const cepInput = document.getElementById("cep");

              cepInput.addEventListener("blur", async () => {
                const cep = cepInput.value.replace(/\D/g, "");
                if (cep.length !== 8) return;

                try {
                  const response = await fetch(`/api/frete?cep_destino=${cep}`);
                  if (!response.ok) throw new Error("Erro ao consultar o CEP");

                  const data = await response.json();

                  // Preenche os campos automaticamente
                  const enderecoParts = data.endereco.split(" - ");
                  document.getElementById("logradouro").value =
                    enderecoParts[0] || "";
                  document.getElementById("bairro").value =
                    enderecoParts[1] || "";
                  document.getElementById("cidade").value =
                    enderecoParts[2] || "";
                  document.getElementById("uf").value = enderecoParts[3] || "";
                } catch (error) {
                  console.error("Erro ao buscar CEP:", error);
                }
              });
            });
          </script>
